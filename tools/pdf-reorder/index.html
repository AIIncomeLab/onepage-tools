<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDF 页面重排</title>
<meta name="description" content="拖拽缩略图调整 PDF 页面顺序后重新导出。">
<link rel="stylesheet" href="/assets/styles.css">
<script src="/assets/layout.js" defer></script>
<script src="https://unpkg.com/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
#pages{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:16px}
.thumb{background:#0f1730;border:1px solid var(--border);border-radius:12px;padding:8px;cursor:grab}
.thumb.dragging{opacity:.5}
.thumb canvas{width:100%;border-radius:8px}
.thumb-number{margin-top:8px;text-align:center;color:var(--muted)}
</style>
</head>
<body>
<header class="container site-header" data-site-header data-title="PDF 页面重排"></header>
<main class="container card">
<label>选择 PDF：</label>
<input class="input" type="file" id="file" accept="application/pdf">
<div id="pages"></div>
<button class="btn" id="run" style="margin-top:16px">导出新的顺序</button>
<div id="msg" class="muted" style="margin-top:12px"></div>
</main>
<footer class="container site-footer" data-site-footer></footer>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://unpkg.com/pdfjs-dist@4.0.379/build/pdf.worker.min.js';
const $=s=>document.querySelector(s);
let currentDocBytes=null;
$('#file').addEventListener('change',async e=>{
  const file=e.target.files[0];
  if(!file) return;
  $('#msg').textContent='生成缩略图中…';
  currentDocBytes=new Uint8Array(await file.arrayBuffer());
  const pdf=await pdfjsLib.getDocument({data:currentDocBytes}).promise;
  const container=$('#pages');
  container.innerHTML='';
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const viewport=page.getViewport({scale:0.3});
    const canvas=document.createElement('canvas');
    canvas.width=viewport.width;
    canvas.height=viewport.height;
    const ctx=canvas.getContext('2d',{alpha:false});
    await page.render({canvasContext:ctx,viewport}).promise;
    const div=document.createElement('div');
    div.className='thumb';
    div.draggable=true;
    div.dataset.index=i-1;
    div.appendChild(canvas);
    const num=document.createElement('div');
    num.className='thumb-number';
    num.textContent=`第 ${i} 页`;
    div.appendChild(num);
    container.appendChild(div);
  }
  $('#msg').textContent='拖拽缩略图调整顺序后点击导出。';
});
const container=$('#pages');
let dragEl=null;
container.addEventListener('dragstart',e=>{
  if(!e.target.classList.contains('thumb')) return;
  dragEl=e.target;
  dragEl.classList.add('dragging');
});
container.addEventListener('dragend',e=>{
  if(dragEl) dragEl.classList.remove('dragging');
  dragEl=null;
});
container.addEventListener('dragover',e=>{
  e.preventDefault();
  const after=[...container.querySelectorAll('.thumb:not(.dragging)')].find(el=>{
    const box=el.getBoundingClientRect();
    return e.clientY<box.top+box.height/2;
  });
  if(!dragEl)return;
  if(after) container.insertBefore(dragEl,after);
  else container.appendChild(dragEl);
});
$('#run').onclick=async()=>{
  if(!currentDocBytes) return alert('请先选择 PDF');
  const order=[...container.querySelectorAll('.thumb')].map(el=>parseInt(el.dataset.index,10));
  const original=await PDFLib.PDFDocument.load(currentDocBytes);
  const out=await PDFLib.PDFDocument.create();
  const copies=await out.copyPages(original, order);
  copies.forEach(p=>out.addPage(p));
  const pdf=await out.save();
  const blob=new Blob([pdf],{type:'application/pdf'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='reordered.pdf';
  a.click();
  $('#msg').textContent='已导出新的顺序。';
};
</script>
</body>
</html>
